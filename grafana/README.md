# Display Fn runtime metrics using Prometheus and Grafana

This tutorial is based on [Nigel Deakin's "Announcing Prometheus Metrics from Fn" blog post](https://medium.com/fnproject/announcing-prometheus-metrics-from-fn-2d0f9ddf0f09).

The Fn server exposes metrics i.e. information about it's performance and resource consumption. This information can be easily made available to monitoring tools to display and analyze the server performance. In this tutorial we will use popular monitoring tools Grafana and Prometheus to visualize Fn server metrics. 

Below is a sample Grafana dashboard showing some Fn server metrics:

![user input](images/GrafanaDashboard.png)

## Before you begin

* Make sure you have cloned the GitHub repo `fnproject/tutorials`
* Make sure you are in the folder `<checked-out-dir>/tutorials/grafana` while executing the docker commands below
* Make sure you have Docker 17.05 or later installed and running
* Make sure you have `fn` CLI tool installed. If you don't have `fn` installed, follow the instructions to **download and install Fn** from the tutorial [Introduction](../Introduction#downloading-and-installing-fn)
* Make sure you have `Fn server` up and running. If it's not running, follow the instructions to **start the Fn server** from the tutorial [Introduction](../Introduction#starting-fn-server)

> As you make your way through this tutorial, look out for this icon ![](../images/userinput.png). Whenever you see it, it's time for you to perform an action.


## Fn server metrics

Currently Fn provides three sets of metrics. We’ll see all three sets of metrics in action later.

* Function counts: the number of functions that are currently queued or are running, and the number of functions that have completed successfully or failed since the server was last started
* Operation durations: these represent the time taken to perform various operations. In addition to obtaining the time taken to execute a function, you can also obtain finer-grained data such as the time taken to start the docker container in which it runs
* Docker metrics: when Fn executes a function in a Docker container it obtains various statistics from that container, such as CPU and memory usage, and makes them available as Prometheus metrics

Fn server makes metrics available using the API endpoint `/metrics` by default. Although this endpoint is intended for use only by Prometheus, you can invoke it yourself to see how it works.

>![user input](../images/userinput.png)
>Point your browser at [http://localhost:8080/metrics](http://localhost:8080/metrics). This will display the metrics in Prometheus format.

So far we have seen the raw metrics data generated by Fn server. Now let's see how to feed this data to Prometheus and then visualize the data using Grafana.

## Introducing Prometheus

[Prometheus](https://prometheus.io/) a popular open-source systems monitoring tool. It is a server process which scrapes metrics data from Fn servers and makes it available via a query API. It polls the Fn metrics endpoint at periodic intervals and saves the values of each metric in a database. If you’re running multiple Fn servers you can configure Prometheus to scrape them all in turn and combine the data together.

Prometheus has a powerful API and query syntax which can be used to obtain values of these metrics. You can obtain historical values of a metric, suitable for displaying on a graph, or you can perform statistical operations such as summing metric values across multiple labels, calculating rates and performing quantile functions. Prometheus also has a web interface which allows you to see what metrics are available, and try out ad-hoc queries.

## Start Prometheus

>![user input](../images/userinput.png)
>Open a terminal window.

Navigate to the directory containing this example.

>![user input](../images/userinput.png)
>```shell
>cd <checked-out-dir>/tutorials/grafana
>```

Examine the provided Prometheus configuration file:

>![user input](../images/userinput.png)
>```shell
>cat prometheus.yml
>```

This shows the contents of `prometheus.yml` file

```
  global:
    scrape_interval:     15s # By default, scrape targets every 15 seconds.

    # Attach these labels to any time series or alerts when communicating with
    # external systems (federation, remote storage, Alertmanager).
    external_labels:
      monitor: 'fn-monitor'

  # A scrape configuration containing exactly one endpoint to scrape:
  # Here it's the Fn server
  scrape_configs:
    # The job name is added as a label `job=<job_name>` to any timeseries scraped from this config.
    - job_name: 'functions'

      # Override the global default and scrape targets from this job every 5 seconds.
      scrape_interval: 5s

      static_configs:
        # Specify all the Fn servers from which metrics will be scraped
        - targets: ['fnserver:8080'] # Uses /metrics by default
```

The last line ` - targets: ... ` specifies the host and port of the Fn server from which metrics will be obtained. *Note:The name `fnserver` used in this example is defined below in the docker command to start Prometheus server.* If you are running a cluster of Fn servers then you can specify them all here.

Check output of the following docker command. This is used in subsequent docker commands to map the docker IP address to the hostname `fnserver`.

>![user input](../images/userinput.png)
>```shell
>docker network inspect bridge -f '{{range .IPAM.Config}}{{.Gateway}}{{end}}'
>```

This should show an IP address like the following:

```
  172.17.0.1
```

Now start Prometheus, specifying the above config file.

>![user input](../images/userinput.png)
>```shell
>docker run --rm --name=prometheus -d -p 9090:9090 \
>  -v `pwd`/prometheus.yml:/etc/prometheus/prometheus.yml \
>  --add-host="fnserver:`docker network inspect bridge -f '{{range .IPAM.Config}}{{.Gateway}}{{end}}'`" \
>  prom/prometheus
>```

Note: This command uses the parameter `--add-host` to define a hostname `fnserver` in the docker container and configure it to use the IP address on which the Fn server is listening.

Open a browser on Prometheus's graph tool at [http://localhost:9090/graph](http://localhost:9090/graph). 

While Prometheus can display tables and graphs of metrics data, it is usually used in conjunction with another popular tool called [Grafana](https://grafana.com/) that fetches data from Prometheus, displays multiple metrics using graphical dashboards and can also generate alerts.

## Introducing Grafana

Now let’s take a look at Grafana. This is another server process, also open source. It has a web interface that you can use to create custom dashboards that pull data from Prometheus (using the full power of the Prometheus query API to perform statistical transformations) and display it graphically to the user.

Fn comes with a number of pre-defined dashboards which showcase all the various metrics provided by the Fn server.

## Start Grafana and load the example dashboard

[Grafana](https://grafana.com/) provides powerful and flexible facilities to create graphs of any metric available to Prometheus. This example provides a ready-made dashboard that displays the numbers of functions that are queued, running, completed and failed. 

Open a terminal window and navigate to the directory containing this example.

Start Grafana on port 5000:
```
docker run --name=grafana -d -p 5000:3000 \
  --add-host="prometheus:`docker network inspect bridge -f '{{range .IPAM.Config}}{{.Gateway}}{{end}}'`" \
  grafana/grafana
```

Open a browser on Grafana at [http://localhost:5000](http://localhost:5000).

Login using the default user `admin` and default password `admin`.

Create a datasource to obtain metrics from Promethesus:
* Click on **Add data source**. In the form that opens:
* Set **Name** to `PromDS` (or whatever name you choose)
* Set **Type** to `Prometheus`
* Set **URL** to `http://prometheus:9090` 
* Set **Access** to `proxy`
* Click **Add** and then **Save and test**

Import the example dashboard that displays metrics from the Fn server:
* Click on the main menu at the top left and choose **Dashboards** and then **Import**
* In the dialog that opens, click **Upload .json file** and specify `fn_grafana_dashboard.json` in this example's directory.
* Specify the Prometheus data source that you just created
* Click **Import**

You should then see the dashboard shown above. Now execute some functions and see the graphs update.

## Tracing metrics

Tracing spans from the Fn server are available as Prometheus metrics. Each span represents a timed internal operation such as a function call, and has
two main attributes: a name that describes the operation being performed (for example `docker_wait_container`), and its duration in seconds. Each span name is represented by a separate histogram metric, which has a name of the form `fn_span_<span-name>_duration_seconds`. 

If the span is associated with a specific function invocation, the corresponding metric is given the labels `fn_app` and `fn_path` which are set to the application name and function path respectively.

A second example dashboard `fn_grafana_dashboard2.json` in this example's directory displays rate and duration data for any number of spans. Use the dropdown lists at the top of the dashboard to choose which tracing spans to examine.

In the following screenshot, the "Choose spans to display rates" dropdown has been used to select `agent_submit` and `serve_http`, and the "Choose spans to display durations" dropdown, has been used to select `agent_cold_exec`, `agent_get_slot`, `agent_submit`, `docker_create_container`, `docker_start_container` and `docker_wait_container`. 

<img src="images/GrafanaDashboard2.png" width="100%">

## Docker statistics

During the execution of the docker container, a selected number of statistics from docker are available as Prometheus metrics. The available metrics are listed in the following table:

| Prometheus metric name |
| ------------- |
| `fn_docker_stats_cpu_kernel` |
| `fn_docker_stats_cpu_kernel`  |
| `fn_docker_stats_cpu_user` |
| `fn_docker_stats_disk_read` |
| `fn_docker_stats_disk_write` |
| `fn_docker_stats_mem_limit` |
| `fn_docker_stats_mem_usage` |
| `fn_docker_stats_net_rx` |
| `fn_docker_stats_net_tx` |
 
 Note that if the container runs for a very short length of time there may be insufficient time to obtain statistics before the container terminates.
 
An example dashboard `fn_grafana_dashboard3.json` in this example's directory displays the available docker statistics. Use the dropdown lists at the top of the dashboard to choose which metrics to examine.

<img src="images/GrafanaDashboard3.png" width="100%">


-------------

# Announcing Prometheus Metrics from Fn


## Try out the Fn metrics endpoint

All you need is an Fn server running at this stage. Start a Fn server:

    fn start

Now create and deploy a function. Here we simply deploy a simple sync function, but you can use any functions you like.

First use the `fn` CLI tool to create a simple boilerplate function:

    mkdir myfunc
    
    cd myfunc
    
    fn init --name myfunc --runtime go

This creates a file `func.go` which simply returns “Hello World!. Modify this to add a short sleep, to make it a bit more realistic. The lines you need to add are marked with `// <---- add this` below

Now build and deploy the function:

    fn deploy --local --app myapp

Invoke the function a few times:

    curl localhost:8080/r/myapp/myfunc
    
    curl localhost:8080/r/myapp/myfunc
    
    curl localhost:8080/r/myapp/myfunc
    
    curl localhost:8080/r/myapp/myfunc

Now type the following to see what is returned by the Prometheus metrics endpoint.

    curl  --silent http://localhost:8080/metrics | grep fn_completed

This will return something like

    # HELP fn_completed Metric fn_completed
    # TYPE fn_completed counter
    fn_completed{fn_appname="myapp",fn_path="/myfunc"} 4

The endpoint returns a long list of metric names and their current values, so we used `grep` to display only the values of the metric `fn_completed`.

This particular metric gives you the number of times a function has run successfully since the server was last started. `fn_appname` and `fn_path` are *labels* which provide more information about a particular metric value. Almost all the metrics provided by Fn are given labels to specify the application and the route (path) of the function.

## Try out Prometheus

Let’s first start a Prometheus server. You can do this very easily in docker:

1.  The `-v` parameter is used to specify a Prometheus confguration file provided with one of the Fn examples. If you look at `${GOPATH}/src/github.com/fnproject/fn/examples/grafana/prometheus.yml` you will see that it tells Prometheus to scrape metrics from `fnserver:8080`

2.  The hostname `fnserver`is an alias, configured using the parameter `--link fnserver` to refer to the running Fn server. This requires the Fn server to be running in docker.

## Dashboard 1: Function Count Metrics

This dashboard demonstrates the first type of Prometheus metric provided by Fn server: function counts.

Start Grafana on port 5000:

Open a browser on Grafana at [http://localhost:5000](http://localhost:5000/).

Login using the default user `admin` and default password `admin`.

Create a datasource to obtain metrics from Prometheus:

* Click on **Add data source**. In the form that opens:
* Set **Name** to `PromDS` (or whatever name you choose)
* Set **Type** to `Prometheus`
* Set **URL** to `http://prometheus:9090`
* Set **Access** to `proxy`
* Click **Add** and then **Save and test**

Now import the example dashboard that displays metrics from the Fn server:

* Click on the main menu at the top left and choose **Dashboards** and then
**Import**
* In the dialog that opens, click **Upload .json file**, navigate to `$GOPATH/src/github.com/fnproject/fn/examples/grafana` and select `fn_grafana_dashboard.json`.
* Specify the Prometheus data source that you just created
* Click **Import**

You should then see the following dashboard. Now invoke your function a few more times and see the graphs update.

![](https://cdn-images-1.medium.com/max/1600/1*kT08JgGMJHmy6fM4x610XQ.png)
<span class="figcaption_hack">Function counts: queued, running, completed, failed</span>

Try invoking your function repeatedly using the following simple script. Paste it into an empty file `run.bash` and then type `bash run.bash`. Let it run whilst you watch the graphs update.

This dashboard shows the four “function count” metrics. From left to right, these are:

* `fn_queued` number of async function calls that are queued
* `fn_running` number of function calls that are currently running
* `fn_completed` number of function calls that have completed successfully
* `fn_failed` number of function calls that have failed

For each type of metric, the dashboard displays two separate graphs, one above the other.

The graph at the bottom shows the raw data, which by default is subdivided by its app and route (path) labels. So you will see one line for each function.

The graph at the top shows the result of performing a Prometheus `sum` expression that adds together the metric values for each function. So the graph shows just one line, the grand total for all functions.

This demonstrates how there is more to using Prometheus than simply displaying a metric. It allows you to perform various statistical transformations on the raw data, performing a `sum` in this case.

## Dashboard 2: Operation Duration Metrics

This dashboard demonstrates the second type of Prometheus metric provided by the Fn server: operation durations. These tell you how much time was taken to perform various internal operations such as executing a function.

These operations are actually tracing spans. Fn uses the [Open Tracing](http://opentracing.io/) API to create tracing spans for various important operations.

Each span represents a timed internal operation such as a function call, and has two main attributes: a name that describes the operation being performed (for example `docker_wait_container`), and its duration in seconds. Each span name is represented by a separate histogram metric, which has a name of the form `fn_span_<span-name>_duration_seconds`.

If you enable tracing in your Fn server (and we’re not going to discuss this further here) you can analyse these tracing spans using Zipkin. All you need to know is that these same tracing spans are also used to generate duration metrics for Prometheus.

If the span is associated with a specific function invocation, the corresponding metric is given the labels `fn_app` and `fn_path` which are set to the application name and function path respectively.

There are several ways in which these metrics can be used. In this dashboard you can display either a rolling mean value of the operation duration, or you can display the operation rate in operations per second.

To try out this dashboard,

* Click on the main menu at the top left and choose **Dashboards** and then
**Import**
* In the dialog that opens, click **Upload .json file**, navigate to `$GOPATH/src/github.com/fnproject/fn/examples/grafana` and select `fn_grafana_dashboard2.json`.
* Specify the Prometheus data source that you created earlier
* Click **Import**

![](https://cdn-images-1.medium.com/max/1600/1*OIf_CUCidG7Uud6zCsNKng.png)
<span class="figcaption_hack">Operation durations</span>

When you first display the dashboard you will see just two graphs. This is the initial, default setting. There are two pull-down lists at the top. Each allows you to choose which operations you wish to display as graphs. The one on the left allows you to choose which operations you wish to display as rates, whilst the one on the right allows you to choose which operations you wish to display as durations. Choose as many as you like.

The three most interesting metrics are

* `fn_span_agent_submit_duration_seconds`
* `fn_span_agent_submit_app_duration_seconds`
* `fn_span_agent_submit_global_duration_seconds`

These operations all correspond to the time taken to execute a function. They represent the same operation, but the first has labels `fn_appname` and `fn_path` set to the application and route (path), the second has just the `fn_appname` label set, and the third has no labels. This makes it easier to construct Prometheus queries by removing the need to sum values across label values.

The following metrics relate to more internal operations. These all have the labels `fn_appname` and `fn_path` set to the application and route (path).

* `fn_span_agent_call_end_duration_seconds`
* `fn_span_agent_call_start_duration_seconds`
* `fn_span_agent_cold_exec_duration_seconds`
* `fn_span_agent_get_slot_duration_seconds`
* `fn_span_agent_attach_container_duration_seconds`
* `fn_span_agent_collect_stats_duration_seconds`
* `fn_span_agent_create_container_duration_seconds`
* `fn_span_agent_inspect_container_duration_seconds`
* `fn_span_agent_inspect_image_duration_seconds`
* `fn_span_agent_remove_container_duration_seconds`
* `fn_span_agent_start_container_duration_seconds`
* `fn_span_agent_wait_container_duration_seconds`
* `fn_span_ds_get_app_duration_seconds`
* `fn_span_ds_get_route_duration_seconds`
* `fn_span_ds_insert_app_duration_seconds`
* `fn_span_ds_insert_call_duration_seconds`
* `fn_span_ds_insert_log_duration_seconds`
* `fn_span_ds_route_duration_seconds`
* `fn_span_ds_update_route_duration_seconds`
* `fn_span_mq_reserve_duration_seconds`
* `fn_span_serve_http_duration_seconds`

## Dashboard 3: Docker Statistics Metrics

This last dashboard demonstrates the third type of Prometheus metric provided by Fn server: docker statistics.

To try out this dashboard,

* Click on the main menu at the top left and choose **Dashboards** and then
**Import**
* In the dialog that opens, click **Upload .json file**, navigate to `$GOPATH/src/github.com/fnproject/fn/examples/grafana` and select `fn_grafana_dashboard3.json`.
* Specify the Prometheus data source that you created earlier
* Click **Import**

![](https://cdn-images-1.medium.com/max/1600/1*5T47isXuH6KGO9v-0PLZ_A.png)
<span class="figcaption_hack">Docker statistics</span>

Once again when you first display this dashboard it will display just one graph. Use the pull-down list at the top to select which particular metrics you desire.

Available metrics are

* `fn_docker_stats_cpu_kernel`
* `fn_docker_stats_cpu_total`
* `fn_docker_stats_cpu_user`
* `fn_docker_stats_disk_read`
* `fn_docker_stats_disk_write`
* `fn_docker_stats_mem_limit`
* `fn_docker_stats_mem_usage`
* `fn_docker_stats_net_rx`
* `fn_docker_stats_net_tx`

As with the duration metrics these all have the labels `fn_appname` and `fn_path` set to the application and route (path).

If you try this with your own functions it is possible that you won’t see any metrics. This might be because your function is very quick then there is insufficient time for docker to obtain the statistics before the container in which the function was running is shut down. The Fn team has contemplated delaying the termination of the container until at least one set of statistics was obtained, but at present has decided not to do this.

## Create your own dashboard

The three dashboards provided with Fn are intended to showcase the wide variety of Prometheus metrics currently available from the Fn server. Using Grafana it’s easy to create your own dashboards which display the data that is important to you.

![](https://cdn-images-1.medium.com/max/1600/1*_eUYzGBPvDEr1AMa_OvjYg.gif)
<span class="figcaption_hack">Fn, Prometheus and Grafana</span>

## What’s Next

* More metrics! We’re adding additional metrics to Fn all the time. For example we’ll be soon be adding metrics allow you to see how many running, stopped and paused Docker containers you have.
* API extensions: Work is in progress on a new extension API which will provide the most useful statistics directly from the Fn server without the need to access Prometheus directly. See [GitHub issue 514](https://github.com/fnproject/fn/issues/514) for details.
* If you build your own dashboard, share it! Add it alongside the existing examples and submit a pull request.

## Learn more

* If you wish you can use this tool to display metrics from the Fn server see the [Prometheus](https://prometheus.io/) documentation for instructions. Alternatively continue with the next step to view a ready-made set of graphs in Grafana.



